<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meal Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
    <!-- Meal Planner Section -->
    <div class="bg-gray-800 rounded-lg shadow-2xl p-4 sm:p-6 md:p-8 mb-10">
      <h1 class="text-4xl sm:text-5xl text-green-500 text-center mb-4">Meal Planner 🌱</h1>
      <div class="text-center mb-4">
        <input id="daysInput" type="number" min="1" max="30" value="5" class="w-20 text-black text-center font-bold rounded p-2">
        <label for="daysInput" class="ml-2 text-lg text-yellow-300">Days</label>
      </div>
      <div class="text-center mb-8 flex flex-wrap justify-center gap-4">
        <button id="selectButton" class="bg-green-500 hover:bg-green-600 text-black font-bold py-3 px-6 rounded-full text-lg">
          🍏 Generate Plan
        </button>
        <button id="resetButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full text-lg">
          🗑 Reset
        </button>
      </div>

      <div id="daysLeft" class="text-center text-yellow-300 mb-4 text-lg font-semibold"></div>
      <div id="result" class="bg-gray-700 p-4 sm:p-6 rounded-lg shadow-inner mb-8 space-y-3"></div>
    </div>

    <!-- Dish Management Section -->
    <div class="bg-gray-800 rounded-lg shadow-2xl p-6">
      <h2 class="text-2xl text-yellow-300 mb-4">🛠 Manage Dishes</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-[2fr_1fr] gap-8">
        <div>
          <div class="flex gap-2 mb-4">
            <button class="group-tab bg-gray-700 hover:bg-green-600 px-4 py-2 rounded font-semibold" data-group="Healthy Home-style Meals">Healthy</button>
            <button class="group-tab bg-gray-700 hover:bg-red-600 px-4 py-2 rounded font-semibold" data-group="Junk Food">Junk</button>
            <button class="group-tab bg-gray-700 hover:bg-pink-600 px-4 py-2 rounded font-semibold" data-group="Dessert">Dessert</button>
          </div>

          <input type="text" id="searchInput" placeholder="Search..." class="w-full px-4 py-2 rounded text-black font-semibold mb-4">

          <div id="dishContainer" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto pr-2"></div>
        </div>

        <div>
          <h2 class="text-2xl text-green-300 mb-2">Add New Dish</h2>
          <div class="space-y-3 bg-gray-700 p-4 rounded-lg shadow">
            <input id="newDishName" type="text" placeholder="Dish Name" class="w-full px-4 py-2 rounded text-black font-semibold">
            <select id="newDishGroup" class="w-full px-4 py-2 rounded text-black font-semibold">
              <option value="Healthy Home-style Meals">Healthy</option>
              <option value="Junk Food">Junk</option>
              <option value="Dessert">Dessert</option>
            </select>
            <button id="addDishBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded w-full">Add Dish</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Dish Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
    <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full">
      <h2 class="text-xl text-green-400 mb-4">Edit Dish</h2>
      <input id="editDishName" type="text" class="w-full px-4 py-2 mb-4 rounded text-black font-semibold">
      <div class="flex justify-between gap-4">
        <button id="saveEditBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Save</button>
        <button id="closeEditBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded w-full">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
    <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full">
      <h2 class="text-xl text-red-400 mb-4">Are you sure you want to delete this dish?</h2>
      <div class="flex justify-between gap-4">
        <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded w-full">Yes, Delete</button>
        <button id="closeDeleteBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded w-full">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDggOxw9S18mf4l-PqkMqVg3YYGc612tQA",
      authDomain: "meal-b14ca.firebaseapp.com",
      databaseURL: "https://meal-b14ca-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "meal-b14ca",
      storageBucket: "meal-b14ca.appspot.com",
      messagingSenderId: "190610959035",
      appId: "1:190610959035:web:6d078d26d0e7e07c86979e",
      measurementId: "G-PKD67YL45V"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const foodRef = db.ref("foodGroups");
    const currentMealPlanRef = db.ref("mealPlan/current");
    const mealPlanMetadataRef = db.ref("mealPlan/metadata");

    let foodGroups = {};
    let daysLeftDisplay = document.getElementById("daysLeft");
    let currentGroup = "Healthy Home-style Meals";
    let displayLimit = 10;
    let renderedCount = 0;
    let selectedDish = "";

    foodRef.on("value", (snapshot) => {
      foodGroups = snapshot.val() || {};
      loadMealPlan();
      renderDishes(true);
    });

    // Meal Planner Functions
    document.getElementById("selectButton").addEventListener("click", generateMealPlan);
    document.getElementById("resetButton").addEventListener("click", clearMealPlan);

    function clearMealPlan() {
      currentMealPlanRef.remove();
      mealPlanMetadataRef.remove();
      document.getElementById("result").innerHTML = "";
      daysLeftDisplay.textContent = "";
    }

    function saveCurrentMealPlan(planHTML, days, planData) {
      const generationDate = new Date().toISOString().split('T')[0];
      currentMealPlanRef.set({
        html: planHTML,
        data: planData
      });
      mealPlanMetadataRef.set({ generationDate, days });
    }

    function loadMealPlan() {
      mealPlanMetadataRef.once('value', metaSnap => {
        const metadata = metaSnap.val();
        if (!metadata) return;
        currentMealPlanRef.once('value', planSnap => {
          const saved = planSnap.val();
          if (saved && saved.html && saved.data) {
            document.getElementById("result").innerHTML = saved.html;
            window.currentPlan = saved.data;
            const expiryDate = new Date(metadata.generationDate);
            expiryDate.setDate(expiryDate.getDate() + parseInt(metadata.days));
            const today = new Date();
            const daysRemaining = Math.max(0, Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)));
            daysLeftDisplay.textContent = `Days Left: ${daysRemaining}`;
          }
        });
      });
    }

    function generateMealPlan() {
      const resultEl = document.getElementById("result");
      const numDays = parseInt(document.getElementById("daysInput").value) || 5;
      let healthy = [...(foodGroups["Healthy Home-style Meals"] || [])];
      let junk = [...(foodGroups["Junk Food"] || [])];
      let dessert = [...(foodGroups["Dessert"] || [])];

      const junkDays = Math.round(numDays * 0.2);
      const healthyDays = numDays - junkDays;
      const dessertCount = Math.floor(numDays / 5);

      let types = Array(healthyDays).fill("Healthy Home-style Meals").concat(Array(junkDays).fill("Junk Food"));
      types.sort(() => Math.random() - 0.5);

      let dessertIndices = [];
      while (dessertIndices.length < dessertCount) {
        let i = Math.floor(Math.random() * numDays);
        if (!dessertIndices.includes(i)) dessertIndices.push(i);
      }

      let plan = [];
      for (let i = 0; i < numDays; i++) {
        let group = types[i];
        let list = group === "Healthy Home-style Meals" ? healthy : junk;
        let item = list.length ? list.splice(Math.floor(Math.random() * list.length), 1)[0] : foodGroups[group][Math.floor(Math.random() * foodGroups[group].length)];
        let dessertItem = dessertIndices.includes(i) && dessert.length ? dessert.splice(Math.floor(Math.random() * dessert.length), 1)[0] : null;
        plan.push({ day: i + 1, group, item, dessert: dessertItem });
      }

      let html = `<h3 class="text-2xl text-green-400 mb-4">🥗 Meal Plan:</h3>`;
      plan.forEach((d, i) => {
        html += `
<div class="relative bg-gray-600 p-4 pt-16 rounded-lg border-l-4 border-green-500 hover:bg-gray-500 transition duration-300 cursor-pointer" onclick="goToDetail(event)">
  ${d.dessert ? `<button class="switch-dessert-btn" onclick="event.stopPropagation(); switchDessert(${i})">Switch Dessert</button>` : ''}
  <button class="switch-btn" onclick="event.stopPropagation(); switchMeal(${i}, '${d.group.replace(/'/g, "\\'")}')">Switch</button>
  <strong class="text-lg">Day ${d.day}</strong>: 
  <span id="meal-${i}">${d.item}</span>
  <em class="text-green-300">(${d.group})</em>
  ${d.dessert ? `<br><span id="dessert-${i}" class="text-pink-300">🍰 Dessert: ${d.dessert}</span>` : ''}
</div>`;
      });

      resultEl.innerHTML = html;
      window.currentPlan = plan;
      saveCurrentMealPlan(html, numDays, plan);
      daysLeftDisplay.textContent = `Days Left: ${numDays}`;
    }

    function switchMeal(index, group) {
      const plan = window.currentPlan;
      const current = plan[index];
      const list = [...(foodGroups[group] || [])].filter(x => x !== current.item);
      if (list.length === 0) return;
      const newItem = list[Math.floor(Math.random() * list.length)];
      current.item = newItem;
      document.getElementById(`meal-${index}`).textContent = newItem;

      // Save updated plan to Firebase
      const updatedHTML = document.getElementById("result").innerHTML;
      const days = parseInt(document.getElementById("daysInput").value) || 5;
      saveCurrentMealPlan(updatedHTML, days, plan);
    }

    function switchDessert(index) {
      const plan = window.currentPlan;
      const current = plan[index];
      const desserts = [...(foodGroups["Dessert"] || [])].filter(x => x !== current.dessert);
      if (desserts.length === 0) return;
      const newDessert = desserts[Math.floor(Math.random() * desserts.length)];
      current.dessert = newDessert;
      document.getElementById(`dessert-${index}`).innerHTML = `🍰 Dessert: ${newDessert}`;

      // Save updated plan to Firebase
      const updatedHTML = document.getElementById("result").innerHTML;
      const days = parseInt(document.getElementById("daysInput").value) || 5;
      saveCurrentMealPlan(updatedHTML, days, plan);
    }

    function goToDetail(e) {
      const clickedEl = e.currentTarget;
      const dishName = clickedEl.querySelector("span[id^='meal-']").textContent.trim();
      const encoded = encodeURIComponent(dishName);
      window.location.href = `detail.html?meal=${encoded}`;
    }

    // Dish Management Functions
    document.querySelectorAll(".group-tab").forEach(button => {
      button.addEventListener("click", () => {
        selectGroup(button.getAttribute("data-group"));
      });
    });

    document.getElementById("searchInput").addEventListener("input", () => renderDishes(true));
    document.getElementById("addDishBtn").addEventListener("click", addDish);

    function selectGroup(group) {
      currentGroup = group;
      renderDishes(true);
    }

    function renderDishes(reset = false) {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const container = document.getElementById("dishContainer");
      if (reset) {
        renderedCount = 0;
        container.innerHTML = "";
      }
      const dishes = (foodGroups[currentGroup] || []).filter(d => d.toLowerCase().includes(search));
      const toShow = dishes.slice(renderedCount, renderedCount + displayLimit);
      renderedCount += displayLimit;

      toShow.forEach(dish => {
        const card = document.createElement("div");
        card.className = "bg-gray-700 p-4 rounded-lg shadow-md relative flex flex-col justify-between";
        card.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <button class="text-yellow-400 hover:text-yellow-300" onclick="editDish('${dish.replace(/'/g, '\\')}')">✏️</button>
            <button class="text-red-400 hover:text-red-300" onclick="openDeleteModal('${dish.replace(/'/g, '\\')}')">🗑️</button>
          </div>
          <div class="text-lg font-bold text-green-300">${dish}</div>
        `;
        container.appendChild(card);
      });
    }

    document.getElementById("dishContainer").addEventListener("scroll", function () {
      const { scrollTop, scrollHeight, clientHeight } = this;
      if (scrollTop + clientHeight >= scrollHeight - 10) renderDishes();
    });

    function addDish() {
      const name = document.getElementById("newDishName").value.trim();
      const group = document.getElementById("newDishGroup").value;
      if (!name) return alert("Enter a dish name");
      const list = foodGroups[group] || [];
      if (list.includes(name)) return alert("Dish already exists");
      list.push(name);
      db.ref(`foodGroups/${group}`).set(list);
      document.getElementById("newDishName").value = "";
      if (group === currentGroup) renderDishes(true);
    }

    function openDeleteModal(dish) {
      selectedDish = dish;
      document.getElementById("deleteModal").classList.remove("hidden");
    }

    function closeDeleteModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }

    function deleteDish() {
      const list = foodGroups[currentGroup].filter(d => d !== selectedDish);
      db.ref(`foodGroups/${currentGroup}`).set(list);
      renderDishes(true);
      closeDeleteModal();
    }

    function editDish(dish) {
      selectedDish = dish;
      document.getElementById("editDishName").value = dish;
      document.getElementById("editModal").classList.remove("hidden");
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.add("hidden");
    }

    function saveEdit() {
      const newDish = document.getElementById("editDishName").value.trim();
      if (!newDish || newDish === selectedDish) return;
      const list = foodGroups[currentGroup].map(d => d === selectedDish ? newDish : d);
      db.ref(`foodGroups/${currentGroup}`).set(list);
      renderDishes(true);
      closeEditModal();
    }

    // Modal event listeners
    document.getElementById("closeEditBtn").addEventListener("click", closeEditModal);
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);
    document.getElementById("closeDeleteBtn").addEventListener("click", closeDeleteModal);
    document.getElementById("confirmDeleteBtn").addEventListener("click", deleteDish);
  </script>

  <style>
    .switch-btn, .switch-dessert-btn {
      position: absolute;
      top: 1rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 600;
      z-index: 10;
      transition: background-color 0.3s ease;
    }
    .switch-btn {
      right: 1rem;
      background-color: #4ade80;
      color: black;
    }
    .switch-btn:hover {
      background-color: #22c55e;
    }
    .switch-dessert-btn {
      right: 6rem;
      background-color: #f472b6;
      color: black;
    }
    .switch-dessert-btn:hover {
      background-color: #ec4899;
    }
  </style>
</body>
</html>
